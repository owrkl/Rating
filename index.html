<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ØªÙ‚ÙŠÙŠÙ… Ø£Ø¹Ø¶Ø§Ø¡ Ø§Ù„Ù‚ÙŠØµØ±ÙŠØ© Ø§Ù„Ø¹Ù…Ø±ÙŠØ©</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;800;900&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Cairo', 'sans-serif'] },
                    colors: {
                        gold: {
                            400: '#FACC15',
                            500: '#EAB308',
                            600: '#CA8A04',
                        },
                        royal: {
                            800: '#1e1b4b',
                            900: '#0f172a',
                        }
                    },
                    animation: {
                        'float': 'float 3s ease-in-out infinite',
                        'shine': 'shine 2s linear infinite',
                    },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' },
                        },
                        shine: {
                            '0%': { transform: 'translateX(-100%)' },
                            '100%': { transform: 'translateX(100%)' }
                        }
                    }
                }
            }
        }
    </script>

    <!-- CRITICAL FIX: Fixed React version mismatch. Removed conflicting react/ v19 entry. -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react/": "https://esm.sh/react@18.2.0/",
            "react-dom": "https://esm.sh/react-dom@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.294.0?external=react",
            "@dnd-kit/core": "https://esm.sh/@dnd-kit/core@6.0.8?external=react,react-dom",
            "@dnd-kit/sortable": "https://esm.sh/@dnd-kit/sortable@7.0.2?external=react,react-dom",
            "@dnd-kit/utilities": "https://esm.sh/@dnd-kit/utilities@3.2.1?external=react,react-dom"
        }
    }
    </script>

    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body {
            background-color: #020617;
            background-image: 
                radial-gradient(circle at 50% 0%, #1e1b4b 0%, transparent 50%),
                radial-gradient(circle at 100% 0%, #312e81 0%, transparent 30%);
            color: #f8fafc;
            min-height: 100vh;
            touch-action: manipulation;
            overscroll-behavior: none;
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
        
        .glass-panel {
            background: rgba(30, 41, 59, 0.4);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .gold-gradient-text {
            background: linear-gradient(135deg, #FDE68A 0%, #D97706 50%, #FDE68A 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-size: 200% auto;
            animation: shine 4s linear infinite;
        }
        
        /* Critical for drag performance */
        .touch-none {
            touch-action: none !important;
        }
    </style>
<link rel="stylesheet" href="/index.css">
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect } from 'react';
        import ReactDOM from 'react-dom/client';
        import { 
            Crown, Star, GripVertical, CheckCircle2, ArrowRight, Trophy, Sparkles, Activity, RotateCcw
        } from 'lucide-react';
        import {
            DndContext, closestCenter, KeyboardSensor, PointerSensor, useSensor, useSensors, TouchSensor, MouseSensor
        } from '@dnd-kit/core';
        import {
            arrayMove, SortableContext, sortableKeyboardCoordinates, verticalListSortingStrategy, useSortable
        } from '@dnd-kit/sortable';
        import { CSS } from '@dnd-kit/utilities';

        // --- Data & Configuration ---
        const BUCKET_ID = 'qaisariya_ranking_v9_zeroed';
        const API_URL = `https://kvdb.io/${BUCKET_ID}/members`;

        const INITIAL_MEMBERS = [
            { id: 'm1', name: 'Ø¹Ù…Ø± Ø­Ø§Ù…Ø¯', title: 'Ø§Ù„Ù‚ÙŠØµØ±', score: 0 },
            { id: 'm2', name: 'Ù…Ø­Ù…Ø¯ ÙØ±Ø­Ø§Ù†', title: 'Ø§Ù…Ø¨Ø±Ø§Ø·ÙˆØ± Ø§Ù„Ø§Ù…Ø¨Ø±Ø§Ø·ÙˆØ±ÙŠØ© Ø§Ù„Ù…Ø­Ù…Ø¯ÙŠØ©', score: 0 },
            { id: 'm3', name: 'Ù…Ø­Ù…Ø¯ Ø¹Ø¨Ø¯ Ø§Ù„Ø¹Ø²ÙŠØ²', title: 'Ø§Ù…Ø¨Ø±Ø§Ø·ÙˆØ± Ø§Ù„Ø§Ù…Ø¨Ø±Ø§Ø·ÙˆØ±ÙŠØ© Ø§Ù„Ø¹Ø²ÙŠØ²ÙŠØ©', score: 0 },
            { id: 'm4', name: 'Ø­Ù…Ø²Ø© ÙˆØ§Ø¦Ù„', title: 'ÙˆØ²ÙŠØ± Ø§Ù„Ø±ÙŠØ§Ø¶Ø© ÙˆØ§Ù„Ø´Ø¨Ø§Ø¨', score: 0 },
            { id: 'm5', name: 'Ø¹Ø¯Ù†Ø§Ù† Ø£Ø­Ù…Ø¯', title: 'ÙˆØ²ÙŠØ± Ø§Ù„ØªÙƒÙ†ÙˆÙ„ÙˆØ¬ÙŠØ§', score: 0 },
        ];

        // --- API Service ---
        const api = {
            async getMembers() {
                try {
                    const res = await fetch(API_URL);
                    if (res.ok) return await res.json();
                    if (res.status === 404) {
                        await api.saveMembers(INITIAL_MEMBERS);
                        return INITIAL_MEMBERS;
                    }
                } catch (e) { console.error(e); }
                return INITIAL_MEMBERS;
            },
            async saveMembers(data) {
                await fetch(API_URL, { method: 'POST', body: JSON.stringify(data) });
            },
            async vote(rankedItems) {
                const current = await api.getMembers();
                const map = new Map(current.map(m => [m.id, m]));
                
                // Scoring
                rankedItems.forEach((item, index) => {
                    const member = map.get(item.id);
                    if (member) {
                        const points = 100 - (index * 20);
                        member.score = (member.score || 0) + points;
                    }
                });
                
                await api.saveMembers(Array.from(map.values()));
                return true;
            }
        };

        // --- Components ---

        const RankBadge = ({ rank }) => {
            if (rank === 1) return <div className="absolute -top-3 w-8 h-8 rounded-full bg-yellow-500 flex items-center justify-center border-2 border-slate-900 shadow-lg z-20 text-slate-900 font-black">1</div>;
            if (rank === 2) return <div className="absolute -top-3 w-8 h-8 rounded-full bg-slate-300 flex items-center justify-center border-2 border-slate-900 shadow-lg z-20 text-slate-900 font-black">2</div>;
            if (rank === 3) return <div className="absolute -top-3 w-8 h-8 rounded-full bg-amber-700 flex items-center justify-center border-2 border-slate-900 shadow-lg z-20 text-slate-100 font-black">3</div>;
            return <div className="text-slate-500 font-bold text-lg w-8 text-center">#{rank}</div>;
        };

        const Podium = ({ members }) => {
            const sorted = [...members].sort((a, b) => b.score - a.score);
            const top3 = [sorted[1], sorted[0], sorted[2]].filter(Boolean);

            return (
                <div className="flex items-end justify-center gap-2 md:gap-6 mb-12 mt-8 px-4">
                    {top3.map((m, i) => {
                        const visualRank = i === 1 ? 1 : i === 0 ? 2 : 3;
                        const isFirst = visualRank === 1;
                        
                        return (
                            <div key={m.id} className={`flex flex-col items-center ${isFirst ? 'w-1/3 z-10' : 'w-1/4 opacity-90'}`}>
                                <div className="relative mb-3 group">
                                    {isFirst && <Crown className="absolute -top-12 left-1/2 -translate-x-1/2 w-10 h-10 text-yellow-400 animate-float drop-shadow-[0_0_10px_rgba(250,204,21,0.5)]" />}
                                    
                                    <div className={`
                                        relative rounded-full border-4 shadow-2xl transition-transform duration-500 group-hover:scale-105
                                        ${isFirst ? 'w-24 h-24 md:w-32 md:h-32 border-yellow-500 shadow-yellow-500/20' : 
                                          visualRank === 2 ? 'w-20 h-20 md:w-24 md:h-24 border-slate-300 shadow-slate-300/10' : 
                                          'w-16 h-16 md:w-20 md:h-20 border-amber-700 shadow-amber-700/10'}
                                    `}>
                                        <div className="w-full h-full rounded-full bg-slate-800 flex items-center justify-center overflow-hidden">
                                            <span className="text-2xl">ğŸ‘¤</span>
                                        </div>
                                        <RankBadge rank={visualRank} />
                                    </div>
                                </div>
                                
                                <div className={`
                                    glass-panel w-full rounded-t-2xl p-3 text-center border-b-0
                                    ${isFirst ? 'h-40 bg-gradient-to-t from-yellow-900/40 to-slate-900/50' : 'h-28 bg-gradient-to-t from-slate-800/40 to-slate-900/50'}
                                `}>
                                    <div className="font-bold text-white text-sm md:text-lg truncate">{m.name}</div>
                                    <div className="text-[10px] md:text-xs text-slate-400 truncate mb-2">{m.title}</div>
                                    <div className="inline-block bg-slate-950/50 rounded-lg px-2 py-1 text-xs font-mono text-emerald-400 border border-emerald-500/20">
                                        {m.score.toLocaleString()}
                                    </div>
                                </div>
                            </div>
                        );
                    })}
                </div>
            );
        };

        const DraggableRow = ({ id, member, index }) => {
            const { attributes, listeners, setNodeRef, transform, transition, isDragging } = useSortable({ id });
            
            const style = {
                transform: CSS.Transform.toString(transform),
                transition,
                zIndex: isDragging ? 50 : 'auto',
                position: 'relative',
            };

            const rankColor = index === 0 ? 'bg-yellow-500 text-black' : index === 1 ? 'bg-slate-300 text-black' : index === 2 ? 'bg-amber-700 text-white' : 'bg-slate-700 text-slate-300';

            return (
                <div 
                    ref={setNodeRef} 
                    style={style} 
                    className={`
                    flex items-center gap-4 p-4 mb-3 rounded-xl border transition-all
                    ${isDragging ? 'bg-indigo-600 border-indigo-400 shadow-2xl scale-105 z-50' : 'glass-panel border-slate-700/50 hover:border-slate-600'}
                `}>
                    <div className={`w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm shadow-lg ${rankColor}`}>
                        {index + 1}
                    </div>
                    
                    <div className="flex-1 select-none pointer-events-none">
                        <div className="font-bold text-white text-lg">{member.name}</div>
                        <div className="text-xs text-slate-400">{member.title}</div>
                    </div>
                    
                    {/* 
                        TOUCH ACTION NONE IS CRITICAL HERE 
                        We attach listeners specifically to this handle
                    */}
                    <div 
                        {...attributes} 
                        {...listeners} 
                        className="p-4 -m-4 cursor-grab active:cursor-grabbing text-slate-500 hover:text-white flex items-center justify-center touch-none"
                    >
                        <GripVertical className="w-8 h-8" />
                    </div>
                </div>
            );
        };

        const LeaderboardScreen = ({ members, onVote }) => {
            const sorted = [...members].sort((a, b) => b.score - a.score);
            const rest = sorted.slice(3);

            return (
                <div className="pb-24 animate-in fade-in duration-700">
                    <div className="text-center pt-10 pb-4 px-4">
                        <div className="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-indigo-500/10 border border-indigo-500/20 text-indigo-400 text-xs font-bold mb-4">
                            <Activity className="w-3 h-3 animate-pulse" />
                            <span>Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±</span>
                        </div>
                        <h1 className="text-4xl md:text-5xl font-black gold-gradient-text mb-2 tracking-tight">
                            Ø§Ù„Ù‚ÙŠØµØ±ÙŠØ© Ø§Ù„Ø¹Ù…Ø±ÙŠØ©
                        </h1>
                        <p className="text-slate-400 text-sm">Ù…Ø¬Ù„Ø³ Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø¥Ù…Ø¨Ø±Ø§Ø·ÙˆØ±ÙŠ</p>
                    </div>

                    <Podium members={members} />

                    <div className="max-w-2xl mx-auto px-4">
                        <h3 className="text-slate-400 text-sm font-bold uppercase tracking-wider mb-4 flex items-center gap-2">
                            <Star className="w-4 h-4" /> Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
                        </h3>
                        <div className="space-y-2">
                            {rest.map((m, i) => (
                                <div key={m.id} className="glass-panel flex items-center gap-4 p-4 rounded-xl border-0 border-l-4 border-slate-700 hover:bg-slate-800/50 transition-colors">
                                    <div className="text-slate-500 font-bold w-6 text-center">#{i + 4}</div>
                                    <div className="w-10 h-10 rounded-full bg-slate-700 flex items-center justify-center text-lg">ğŸ‘¤</div>
                                    <div className="flex-1">
                                        <div className="font-bold text-slate-200">{m.name}</div>
                                        <div className="text-xs text-slate-500">{m.title}</div>
                                    </div>
                                    <div className="font-mono text-emerald-500 font-bold">{m.score.toLocaleString()}</div>
                                </div>
                            ))}
                        </div>
                    </div>

                    <div className="fixed bottom-0 left-0 right-0 p-6 bg-gradient-to-t from-slate-950 via-slate-950/90 to-transparent pointer-events-none flex justify-center z-50">
                        <button 
                            onClick={onVote}
                            className="pointer-events-auto bg-white text-slate-950 font-black py-4 px-10 rounded-2xl shadow-[0_0_30px_rgba(255,255,255,0.2)] flex items-center gap-3 transform transition hover:scale-105 active:scale-95"
                        >
                            <span>Ø¨Ø¯Ø¡ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</span>
                            <ArrowRight className="w-5 h-5" />
                        </button>
                    </div>
                </div>
            );
        };

        const VotingScreen = ({ members, onSubmit, onCancel }) => {
            const [items, setItems] = useState(members);
            const [submitting, setSubmitting] = useState(false);
            
            // CRITICAL SENSOR FIX
            // Using PointerSensor with minimum distance prevents accidental clicks but allows smooth drag.
            // touch-action: none on the handle (via class 'touch-none') ensures the browser doesn't steal the event.
            const sensors = useSensors(
                useSensor(PointerSensor, {
                    activationConstraint: {
                        distance: 5, // 5px movement required to start drag
                    },
                }),
                useSensor(KeyboardSensor, { coordinateGetter: sortableKeyboardCoordinates })
            );

            const handleDragEnd = (event) => {
                const { active, over } = event;
                if (over && active.id !== over.id) {
                    setItems((items) => {
                        const oldIndex = items.findIndex((i) => i.id === active.id);
                        const newIndex = items.findIndex((i) => i.id === over.id);
                        return arrayMove(items, oldIndex, newIndex);
                    });
                }
            };

            return (
                <div className="min-h-screen bg-slate-950 pb-32 animate-in slide-in-from-bottom duration-500">
                    <div className="sticky top-0 z-40 bg-slate-950/80 backdrop-blur-lg border-b border-slate-800 p-4 flex items-center justify-between">
                        <button onClick={onCancel} className="p-2 hover:bg-slate-800 rounded-full text-slate-400">
                            <ArrowRight />
                        </button>
                        <h2 className="font-bold text-white">Ø±ØªØ¨ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡</h2>
                        <div className="w-10"></div>
                    </div>

                    <div className="p-4 max-w-lg mx-auto">
                        <div className="bg-indigo-900/20 border border-indigo-500/20 rounded-xl p-4 mb-6 flex items-start gap-3">
                            <Sparkles className="w-5 h-5 text-indigo-400 shrink-0 mt-0.5" />
                            <p className="text-sm text-indigo-200">Ø§Ø³Ø­Ø¨ <span className="text-white font-bold">Ø§Ù„Ù…Ù‚Ø¨Ø¶</span> (III) Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡.</p>
                        </div>

                        <DndContext sensors={sensors} collisionDetection={closestCenter} onDragEnd={handleDragEnd}>
                            <SortableContext items={items.map(i => i.id)} strategy={verticalListSortingStrategy}>
                                {items.map((m, i) => <DraggableRow key={m.id} id={m.id} member={m} index={i} />)}
                            </SortableContext>
                        </DndContext>
                    </div>

                    <div className="fixed bottom-0 left-0 right-0 p-4 bg-slate-950 border-t border-slate-800">
                        <button 
                            onClick={async () => {
                                setSubmitting(true);
                                await onSubmit(items);
                                setSubmitting(false);
                            }}
                            disabled={submitting}
                            className="w-full max-w-lg mx-auto bg-emerald-500 hover:bg-emerald-400 text-slate-900 font-bold py-4 rounded-xl shadow-lg shadow-emerald-900/20 flex items-center justify-center gap-2 transition-all active:scale-95 disabled:opacity-50"
                        >
                            {submitting ? 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...' : <><CheckCircle2 /> <span>Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</span></>}
                        </button>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [view, setView] = useState('LEADERBOARD');
            const [members, setMembers] = useState([]);
            const [loading, setLoading] = useState(true);

            const refresh = async () => {
                const data = await api.getMembers();
                setMembers(data);
                setLoading(false);
            };

            useEffect(() => {
                refresh();
                const interval = setInterval(refresh, 10000);
                return () => clearInterval(interval);
            }, []);

            if (loading) return (
                <div className="h-screen flex flex-col items-center justify-center gap-4">
                    <div className="w-12 h-12 border-4 border-indigo-500 border-t-transparent rounded-full animate-spin"></div>
                    <div className="text-indigo-400 font-bold animate-pulse">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ù‚ÙŠØµØ±ÙŠØ©...</div>
                </div>
            );

            if (view === 'SUCCESS') return (
                <div className="h-screen flex flex-col items-center justify-center p-6 text-center animate-in zoom-in duration-300">
                    <div className="w-24 h-24 bg-emerald-500/10 rounded-full flex items-center justify-center mb-6">
                        <Trophy className="w-12 h-12 text-emerald-400" />
                    </div>
                    <h2 className="text-3xl font-black text-white mb-2">ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… ØªÙ‚ÙŠÙŠÙ…Ùƒ!</h2>
                    <p className="text-slate-400 mb-8">ØµÙˆØªÙƒ ÙŠØ³Ø§Ù‡Ù… ÙÙŠ ØªØ­Ø¯ÙŠØ¯ Ø¥Ù…Ø¨Ø±Ø§Ø·ÙˆØ± Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„.</p>
                    <button onClick={() => setView('LEADERBOARD')} className="bg-slate-800 text-white px-8 py-3 rounded-xl font-bold flex items-center gap-2 hover:bg-slate-700">
                        <RotateCcw className="w-4 h-4" /> Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ØªØ±ØªÙŠØ¨
                    </button>
                </div>
            );

            return view === 'VOTING' 
                ? <VotingScreen members={members} onSubmit={async (items) => { await api.vote(items); await refresh(); setView('SUCCESS'); }} onCancel={() => setView('LEADERBOARD')} />
                : <LeaderboardScreen members={members} onVote={() => setView('VOTING')} />;
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
<script type="module" src="/index.tsx"></script>
</body>
</html>