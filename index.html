<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ØªÙ‚ÙŠÙŠÙ… Ø£Ø¹Ø¶Ø§Ø¡ Ø§Ù„Ù‚ÙŠØµØ±ÙŠØ© Ø§Ù„Ø¹Ù…Ø±ÙŠØ©</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Cairo', 'sans-serif'] },
                    colors: { gold: { 400: '#FACC15', 500: '#EAB308', 600: '#CA8A04' }, royal: { 800: '#1e1b4b', 900: '#0f172a' } },
                    animation: { 'float': 'float 3s ease-in-out infinite', 'shine': 'shine 2s linear infinite' },
                    keyframes: { float: { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-10px)' } }, shine: { '0%': { transform: 'translateX(-100%)' }, '100%': { transform: 'translateX(100%)' } } }
                }
            }
        }
    </script>

    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body { background-color: #020617; background-image: radial-gradient(circle at 50% 0%, #1e1b4b 0%, transparent 50%), radial-gradient(circle at 100% 0%, #312e81 0%, transparent 30%); color: #f8fafc; min-height: 100vh; touch-action: manipulation; overscroll-behavior: none; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
        .glass-panel { background: rgba(30, 41, 59, 0.4); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.05); }
        .gold-gradient-text { background: linear-gradient(135deg, #FDE68A 0%, #D97706 50%, #FDE68A 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-size: 200% auto; animation: shine 4s linear infinite; }
        .touch-none { touch-action: none !important; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react/": "https://esm.sh/react@18.2.0/",
            "react-dom": "https://esm.sh/react-dom@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.294.0?external=react",
            "@dnd-kit/core": "https://esm.sh/@dnd-kit/core@6.0.8?external=react,react-dom",
            "@dnd-kit/sortable": "https://esm.sh/@dnd-kit/sortable@7.0.2?external=react,react-dom,@dnd-kit/core",
            "@dnd-kit/utilities": "https://esm.sh/@dnd-kit/utilities@3.2.1?external=react,react-dom"
        }
    }
    </script>
    <script type="text/babel" data-type="module">
        import React, { useState, useEffect } from 'react';
        import ReactDOM from 'react-dom/client';
        import { Crown, Star, GripVertical, CheckCircle2, ArrowRight, Trophy, Sparkles, Activity, RotateCcw } from 'lucide-react';
        import { DndContext, closestCenter, KeyboardSensor, PointerSensor, TouchSensor, useSensor, useSensors } from '@dnd-kit/core';
        import { arrayMove, SortableContext, sortableKeyboardCoordinates, verticalListSortingStrategy, useSortable } from '@dnd-kit/sortable';
        import { CSS } from '@dnd-kit/utilities';

        const MASTER_KEY = 'Ø­Ø·_Ù…ÙØªØ§Ø­Ùƒ_Ù‡ÙˆÙ†_$2a$'; 
        const BIN_ID = '6984c4beae596e708f13c485';
        const API_URL = `https://api.jsonbin.io/v3/b/${BIN_ID}`;

        const INITIAL_MEMBERS = [
            { id: 'm1', name: 'Ø¹Ù…Ø± Ø­Ø§Ù…Ø¯', title: 'Ø§Ù„Ù‚ÙŠØµØ±', score: 0 },
            { id: 'm2', name: 'Ù…Ø­Ù…Ø¯ ÙØ±Ø­Ø§Ù†', title: 'Ø§Ù…Ø¨Ø±Ø§Ø·ÙˆØ± Ø§Ù„Ø§Ù…Ø¨Ø±Ø§Ø·ÙˆØ±ÙŠØ© Ø§Ù„Ù…Ø­Ù…Ø¯ÙŠØ©', score: 0 },
            { id: 'm3', name: 'Ù…Ø­Ù…Ø¯ Ø¹Ø¨Ø¯ Ø§Ù„Ø¹Ø²ÙŠØ²', title: 'Ø§Ù…Ø¨Ø±Ø§Ø·ÙˆØ± Ø§Ù„Ø§Ù…Ø¨Ø±Ø§Ø·ÙˆØ±ÙŠØ© Ø§Ù„Ø¹Ø²ÙŠØ²ÙŠØ©', score: 0 },
            { id: 'm4', name: 'Ø­Ù…Ø²Ø© ÙˆØ§Ø¦Ù„', title: 'ÙˆØ²ÙŠØ± Ø§Ù„Ø±ÙŠØ§Ø¶Ø© ÙˆØ§Ù„Ø´Ø¨Ø§Ø¨', score: 0 },
            { id: 'm5', name: 'Ø¹Ø¯Ù†Ø§Ù† Ø£Ø­Ù…Ø¯', title: 'ÙˆØ²ÙŠØ± Ø§Ù„ØªÙƒÙ†ÙˆÙ„ÙˆØ¬ÙŠØ§', score: 0 },
        ];

        const api = {
            async getMembers() {
                try {
                    const res = await fetch(API_URL, { headers: { 'X-Master-Key': MASTER_KEY, 'X-Bin-Meta': 'false' } });
                    if (res.ok) { const data = await res.json(); return data.members || INITIAL_MEMBERS; }
                } catch (e) { console.error(e); }
                return INITIAL_MEMBERS;
            },
            async saveMembers(data) {
                try {
                    await fetch(API_URL, { method: 'PUT', headers: { 'Content-Type': 'application/json', 'X-Master-Key': MASTER_KEY }, body: JSON.stringify({ members: data }) });
                } catch (e) { console.error(e); }
            },
            async vote(rankedItems) {
                const current = await api.getMembers();
                const map = new Map(current.map(m => [m.id, m]));
                rankedItems.forEach((item, index) => {
                    const member = map.get(item.id);
                    if (member) member.score = (member.score || 0) + (100 - (index * 20));
                });
                await api.saveMembers(Array.from(map.values()));
                return true;
            }
        };

        const RankBadge = ({ rank }) => {
            const colors = rank === 1 ? 'bg-yellow-500' : rank === 2 ? 'bg-slate-300' : rank === 3 ? 'bg-amber-700 text-white' : '';
            if (rank <= 3) return <div className={`absolute -top-3 w-8 h-8 rounded-full ${colors} flex items-center justify-center border-2 border-slate-900 shadow-lg z-20 text-slate-900 font-black`}>{rank}</div>;
            return <div className="text-slate-500 font-bold text-lg w-8 text-center">#{rank}</div>;
        };

        const Podium = ({ members }) => {
            const sorted = [...members].sort((a, b) => b.score - a.score);
            const top3 = [sorted[1], sorted[0], sorted[2]].filter(Boolean);
            return (
                <div className="flex items-end justify-center gap-2 md:gap-6 mb-12 mt-8 px-4">
                    {top3.map((m, i) => {
                        const rank = i === 1 ? 1 : i === 0 ? 2 : 3;
                        return (
                            <div key={m.id} className={`flex flex-col items-center ${rank === 1 ? 'w-1/3 z-10' : 'w-1/4 opacity-90'}`}>
                                <div className="relative mb-3 group">
                                    {rank === 1 && <Crown className="absolute -top-12 left-1/2 -translate-x-1/2 w-10 h-10 text-yellow-400 animate-float" />}
                                    <div className={`relative rounded-full border-4 ${rank === 1 ? 'w-24 h-24 md:w-32 md:h-32 border-yellow-500' : 'w-16 h-16 md:w-24 border-slate-500'}`}>
                                        <div className="w-full h-full rounded-full bg-slate-800 flex items-center justify-center overflow-hidden text-2xl">ðŸ‘¤</div>
                                        <RankBadge rank={rank} />
                                    </div>
                                </div>
                                <div className="glass-panel w-full rounded-t-2xl p-2 text-center">
                                    <div className="font-bold text-white text-xs md:text-sm truncate">{m.name}</div>
                                    <div className="text-emerald-400 font-mono text-xs">{m.score}</div>
                                </div>
                            </div>
                        );
                    })}
                </div>
            );
        };

        const DraggableRow = ({ id, member, index }) => {
            const { attributes, listeners, setNodeRef, transform, transition, isDragging } = useSortable({ id });
            const style = { transform: CSS.Transform.toString(transform), transition, zIndex: isDragging ? 50 : 'auto' };
            return (
                <div ref={setNodeRef} style={style} className={`flex items-center gap-4 p-4 mb-3 rounded-xl border glass-panel ${isDragging ? 'scale-105 bg-indigo-600' : ''}`}>
                    <div className="w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center font-bold">{index + 1}</div>
                    <div className="flex-1 text-right"><div className="font-bold">{member.name}</div><div className="text-xs text-slate-400">{member.title}</div></div>
                    <div {...attributes} {...listeners} className="p-2 touch-none cursor-grab"><GripVertical /></div>
                </div>
            );
        };

        const App = () => {
            const [view, setView] = useState('L');
            const [members, setMembers] = useState([]);
            const [loading, setLoading] = useState(true);
            const refresh = async () => { const d = await api.getMembers(); setMembers(d); setLoading(false); };
            useEffect(() => { refresh(); const i = setInterval(refresh, 10000); return () => clearInterval(i); }, []);

            if (loading) return <div className="h-screen flex items-center justify-center text-indigo-400 animate-pulse font-bold">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚ÙŠØµØ±ÙŠØ©...</div>;
            
            if (view === 'V') return (
                <div className="p-4 pb-32">
                    <DndContext sensors={useSensors(useSensor(PointerSensor), useSensor(TouchSensor, { activationConstraint: { delay: 250, tolerance: 5 } }))} collisionDetection={closestCenter} onDragEnd={(e) => {
                        const { active, over } = e;
                        if (over && active.id !== over.id) {
                            setMembers(m => { const old = m.findIndex(x => x.id === active.id); const next = m.findIndex(x => x.id === over.id); return arrayMove(m, old, next); });
                        }
                    }}>
                        <SortableContext items={members.map(m => m.id)} strategy={verticalListSortingStrategy}>
                            {members.map((m, i) => <DraggableRow key={m.id} id={m.id} member={m} index={i} />)}
                        </SortableContext>
                    </DndContext>
                    <button onClick={async () => { await api.vote(members); setView('S'); }} className="fixed bottom-8 left-1/2 -translate-x-1/2 bg-emerald-500 text-slate-900 px-12 py-4 rounded-2xl font-bold shadow-xl">Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</button>
                </div>
            );

            if (view === 'S') return <div className="h-screen flex flex-col items-center justify-center gap-6"><Trophy className="w-20 h-20 text-emerald-400" /><h2 className="text-2xl font-bold">ØªÙ… Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…!</h2><button onClick={() => setView('L')} className="bg-slate-800 px-6 py-2 rounded-lg">Ø¹ÙˆØ¯Ø©</button></div>;

            return (
                <div className="pb-20">
                    <div className="text-center py-10"><h1 className="text-4xl font-black gold-gradient-text">Ø§Ù„Ù‚ÙŠØµØ±ÙŠØ© Ø§Ù„Ø¹Ù…Ø±ÙŠØ©</h1></div>
                    <Podium members={members} />
                    <button onClick={() => setView('V')} className="fixed bottom-8 left-1/2 -translate-x-1/2 bg-white text-slate-950 px-12 py-4 rounded-2xl font-bold shadow-2xl">Ø¨Ø¯Ø¡ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</button>
                </div>
            );
        };
        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
